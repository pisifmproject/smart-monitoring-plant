# Deploy PISIFM - Complete Deployment Script
# Script untuk deploy aplikasi PISIFM ke Apache

Write-Host "===============================================" -ForegroundColor Cyan
Write-Host "  PISIFM Deployment Script" -ForegroundColor Cyan
Write-Host "===============================================" -ForegroundColor Cyan
Write-Host ""

# 1. Build Frontend
Write-Host "[1/5] Building Frontend..." -ForegroundColor Yellow
Set-Location "C:\Users\netcom\Documents\ifm_septian\project\PISIFM\pisifmfe\frontend"
npm run build
if ($LASTEXITCODE -eq 0) {
    Write-Host "✓ Frontend build successful" -ForegroundColor Green
} else {
    Write-Host "✗ Frontend build failed" -ForegroundColor Red
    exit 1
}
Write-Host ""

# 2. Build Backend
Write-Host "[2/5] Building Backend..." -ForegroundColor Yellow
Set-Location "C:\Users\netcom\Documents\ifm_septian\project\PISIFM\pisifmbe"
npm run build
if ($LASTEXITCODE -eq 0) {
    Write-Host "✓ Backend build successful" -ForegroundColor Green
} else {
    Write-Host "✗ Backend build failed" -ForegroundColor Red
    exit 1
}
Write-Host ""

# 3. Restart Apache
Write-Host "[3/5] Restarting Apache..." -ForegroundColor Yellow
& "C:\MyServer\Apache24\bin\httpd.exe" -k restart
Start-Sleep -Seconds 2
Write-Host "✓ Apache restarted" -ForegroundColor Green
Write-Host ""

# 4. Check if backend is running
Write-Host "[4/5] Checking Backend Status..." -ForegroundColor Yellow
$backendProcess = Get-Process -Name node -ErrorAction SilentlyContinue
if ($backendProcess) {
    Write-Host "✓ Backend is running (PID: $($backendProcess.Id))" -ForegroundColor Green
    Write-Host "  To restart backend, stop it manually and run start-backend.bat" -ForegroundColor Yellow
} else {
    Write-Host "✓ Backend is not running" -ForegroundColor Yellow
}
Write-Host ""

# 5. Get IP Address
Write-Host "[5/5] Network Information..." -ForegroundColor Yellow
$ipAddress = (Get-NetIPAddress -AddressFamily IPv4 | Where-Object { $_.InterfaceAlias -notmatch "Loopback" -and $_.IPAddress -notmatch "^169" } | Select-Object -First 1).IPAddress
Write-Host "✓ Local IP Address: $ipAddress" -ForegroundColor Green
Write-Host ""

# Summary
Write-Host "===============================================" -ForegroundColor Cyan
Write-Host "  Deployment Complete!" -ForegroundColor Green
Write-Host "===============================================" -ForegroundColor Cyan
Write-Host ""
Write-Host "Next Steps:" -ForegroundColor Yellow
Write-Host "1. Start Backend: Run 'start-backend.bat' or 'start-backend.ps1'" -ForegroundColor White
Write-Host "2. Access Website:" -ForegroundColor White
Write-Host "   - Local: http://localhost" -ForegroundColor Cyan
Write-Host "   - Network: http://$ipAddress" -ForegroundColor Cyan
Write-Host ""
Write-Host "3. Configure Firewall (if needed):" -ForegroundColor White
Write-Host "   netsh advfirewall firewall add rule name=`"Apache HTTP`" dir=in action=allow protocol=TCP localport=80" -ForegroundColor Gray
Write-Host ""
