import { Router, Request, Response } from "express";
import {
  generateAndSaveDailyReport,
  fetchDailyReport,
  fetchMonthlyReport,
  fetchAllDailyReports,
} from "./lvmdp_1.dailyReport.services";

const router = Router();

/**
 * POST /api/lvmdp1/daily-report/generate
 * Generate & save daily report untuk hari tertentu
 * Query: ?date=YYYY-MM-DD (default: hari ini)
 */
router.post("/generate", async (req: Request, res: Response) => {
  try {
    let dateStr =
      (req.query.date as string) ?? new Date().toISOString().slice(0, 10);
    // Validasi format YYYY-MM-DD
    const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
    if (!dateRegex.test(dateStr)) {
      return res.status(400).json({
        success: false,
        message: `Invalid date format: ${dateStr}. Expected YYYY-MM-DD`,
      });
    }
    const report = await generateAndSaveDailyReport(dateStr);
    res.status(201).json({
      success: true,
      message: `Daily report untuk ${dateStr} berhasil dibuat`,
      data: report,
    });
  } catch (error: any) {
    res.status(500).json({
      success: false,
      message: error.message || "Gagal generate daily report",
    });
  }
});

/**
 * GET /api/lvmdp1/daily-report/:date
 * Fetch daily report untuk satu hari
 * Params: date (YYYY-MM-DD)
 */
router.get("/:date", async (req: Request, res: Response) => {
  try {
    const { date } = req.params;
    // Validasi format YYYY-MM-DD
    const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
    if (!dateRegex.test(date)) {
      return res.status(400).json({
        success: false,
        message: `Invalid date format: ${date}. Expected YYYY-MM-DD`,
      });
    }
    const report = await fetchDailyReport(date);
    res.status(200).json({
      success: true,
      data: report.length > 0 ? report[0] : null,
    });
  } catch (error: any) {
    res.status(500).json({
      success: false,
      message: error.message || "Gagal fetch daily report",
    });
  }
});

/**
 * GET /api/lvmdp1/daily-report/monthly/:year/:month
 * Fetch monthly report
 * Params: year, month (1-12)
 */
router.get("/monthly/:year/:month", async (req: Request, res: Response) => {
  try {
    const year = Number(req.params.year);
    const month = Number(req.params.month);

    if (isNaN(year) || isNaN(month) || month < 1 || month > 12) {
      return res.status(400).json({
        success: false,
        message: "Year dan month harus valid",
      });
    }

    const reports = await fetchMonthlyReport(year, month);
    res.status(200).json({
      success: true,
      data: reports,
    });
  } catch (error: any) {
    res.status(500).json({
      success: false,
      message: error.message || "Gagal fetch monthly report",
    });
  }
});

/**
 * GET /api/lvmdp1/daily-report/all
 * Fetch semua daily report
 */
router.get("/all", async (req: Request, res: Response) => {
  try {
    const reports = await fetchAllDailyReports();
    res.status(200).json({
      success: true,
      data: reports,
    });
  } catch (error: any) {
    res.status(500).json({
      success: false,
      message: error.message || "Gagal fetch all daily reports",
    });
  }
});

export default router;
