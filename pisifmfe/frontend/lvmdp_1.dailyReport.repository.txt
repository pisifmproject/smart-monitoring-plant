import { db } from "../../db";
import { dailyReportLVMDP1 } from "../../db/schema";
import { eq, gte, lte, and } from "drizzle-orm";

type DailyReportInsert = typeof dailyReportLVMDP1.$inferInsert;

/**
 * Simpan daily report untuk LVMDP 1
 */
export const saveDailyReport = async (data: DailyReportInsert) => {
  return await db
    .insert(dailyReportLVMDP1)
    .values(data)
    .onConflictDoUpdate({
      target: dailyReportLVMDP1.reportDate,
      set: {
        shift1Count: data.shift1Count,
        shift1AvgKwh: data.shift1AvgKwh,
        shift1AvgCurrent: data.shift1AvgCurrent,
        shift2Count: data.shift2Count,
        shift2AvgKwh: data.shift2AvgKwh,
        shift2AvgCurrent: data.shift2AvgCurrent,
        shift3Count: data.shift3Count,
        shift3AvgKwh: data.shift3AvgKwh,
        shift3AvgCurrent: data.shift3AvgCurrent,
        updatedAt: new Date(),
      },
    })
    .returning();
};

/**
 * Ambil daily report untuk satu hari
 */
export const getDailyReportByDate = async (reportDate: Date) => {
  // Validasi Date object
  if (isNaN(reportDate.getTime())) {
    throw new Error(`Invalid date object: ${reportDate}`);
  }
  return await db
    .select()
    .from(dailyReportLVMDP1)
    .where(eq(dailyReportLVMDP1.reportDate, reportDate))
    .limit(1);
};

/**
 * Ambil daily report untuk range bulan (monthly report)
 */
export const getDailyReportByMonth = async (year: number, month: number) => {
  const startDate = new Date(year, month - 1, 1);
  const endDate = new Date(year, month, 0); // last day of month

  return await db
    .select()
    .from(dailyReportLVMDP1)
    .where(
      and(
        gte(dailyReportLVMDP1.reportDate, startDate),
        lte(dailyReportLVMDP1.reportDate, endDate)
      )
    )
    .orderBy(dailyReportLVMDP1.reportDate);
};

/**
 * Ambil semua daily report
 */
export const getAllDailyReports = async () => {
  return await db
    .select()
    .from(dailyReportLVMDP1)
    .orderBy(dailyReportLVMDP1.reportDate);
};
